function C = quat2rot(q)
%C = quat2rot(q)
% C is a 3x3 Rotation matrix from quaternion q
q = permute(q,[1 3 2]);

C = [
   q(1,1,:).^2+q(2,1,:).^2-q(3,1,:).^2-q(4,1,:).^2 2.0.*(q(2,1,:).*q(3,1,:)-q(1,1,:).*q(4,1,:))   2.0.*(q(2,1,:).*q(4,1,:)+q(1,1,:).*q(3,1,:))
   2.0.*(q(2,1,:).*q(3,1,:)+q(1,1,:).*q(4,1,:))   q(1,1,:).^2-q(2,1,:).^2+q(3,1,:).^2-q(4,1,:).^2 2.0.*(q(3,1,:).*q(4,1,:)-q(1,1,:).*q(2,1,:))
   2.0.*(q(2,1,:).*q(4,1,:)-q(1,1,:).*q(3,1,:))   2.0.*(q(3,1,:).*q(4,1,:)+q(1,1,:).*q(2,1,:))   q(1,1,:).^2-q(2,1,:).^2-q(3,1,:).^2+q(4,1,:).^2];

